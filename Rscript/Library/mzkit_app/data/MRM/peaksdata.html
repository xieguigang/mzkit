<!doctype html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="BioDeep代谢组数据库平台" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="xieguigang, 'gg.xie@bionovogene.com'" />
    <meta name="github" content="https://github.com/xieguigang" />
    <meta name="theme-color" content="#712cf9" />

    <title>BioDeep代谢组数据库平台 · 苏州帕诺米克生物医药科技有限公司 BioDeep™</title>

    <script type="text/javascript" src="https://query.biodeep.cn/resources/vendor/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://query.biodeep.cn/resources/vendor/linq.js"></script>
    <script type="text/javascript" src="https://query.biodeep.cn/resources/vendor/fontawesome/js/all.min.js"></script>

    <script type="text/javascript"
        src="https://query.biodeep.cn/resources/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript"
        src="https://query.biodeep.cn/resources/vendor/echarts-5.5.0/echarts.min.js"></script>
    <script type="text/javascript" src="https://query.biodeep.cn/resources/js/biodeepdb_v3.js?var=20250613"></script>

    <link href="https://query.biodeep.cn/resources/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://query.biodeep.cn/resources/vendor/fontawesome/css/all.min.css" rel="stylesheet" />

    <link rel="shortcut icon" href="https://query.biodeep.cn/favicon.ico" />
</head>

<body class="d-flex flex-column h-100">
    <!-- Begin page content -->
    <main class="flex-shrink-0">
        <div class="container" style="max-width: 100%;">
            <h1>View Chromatogram</h1>

            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home"
                        type="button" role="tab" aria-controls="nav-home" aria-selected="true">File Viewer</button>
                    <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile"
                        type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Ion Viewer</button>

                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                    <div class="row">
                        <div id="files" class="col">

                        </div>
                        <div class="col-10">
                            <h3 id="filename"></h3>

                            <div class="row">
                                <div id="xic" class="col" style="height:500px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                    <div class="row">
                        <div id="ions" class="col">

                        </div>
                        <div class="col-10">
                            <h3 id="ionname"></h3>

                            <div class="row">
                                <div id="overlaps" class="col" style="height:500px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</body>

<script type="plain/text" id="xic-data">{$xic}</script>
<script type="plain/text" id="area-data">{$area}</script>

<script type="text/javascript">
    let xic = JSON.parse(base64_decode($ts.text("#xic-data")));
    let tpa = JSON.parse(base64_decode($ts.text("#area-data")));
    let fileset = $ts("<ul>");
    let totalIons = [];
    let show_tic = function (data, tag) {
        var spectrum = pages.spectrum;
        var chartDom = document.getElementById(tag);
        var myChart = window.echarts.init(chartDom);
        var option;
        var xic_lines = $from(spectrum.tic_aggregate(data)).Select(function (a) { return spectrum.format_xic(a); });
        option = {
            xAxis: {},
            yAxis: {},
            series: xic_lines.ToArray(),
            tooltip: {
                trigger: 'item'
            },
            legend: {
                data: xic_lines.Select(function (a) { return a.name; }).ToArray()
            }
        };
        option && myChart.setOption(option);
    };

    $ts("#files").display(fileset);

    console.log(xic);
    console.log(tpa);

    for (let name of Object.keys(xic)) {
        let fileLink = $ts("<li>").display($ts("<a>", { href: "#" }).display(name));
        let fileXic = $from(xic[name]);
        let xic_data = fileXic.Select(function (a) {
            let data = $from(a.chromatogram);

            return {
                rt: data.Select(i => i.Time).ToArray(),
                intensity: data.Select(i => i.Intensity).ToArray(),
                adducts: a.description
            };
        }).ToArray();

        totalIons = [...totalIons, ...xic[name]];
        fileset.appendElement(fileLink);
        fileLink.onclick = function () {
            console.log(fileXic);
            $ts("#filename").display(name);
            show_tic(xic_data, "xic");
        }
    }

    console.table(totalIons);

    let ions_menu = $ts("#ions");
    let ions_list = $ts("<ol>");

    ions_menu.appendElement(ions_list);
    totalIons = $from(totalIons).GroupBy(i => i.description);

    for (let ion of totalIons.ToArray()) {
        let name = ion.Key;
        let ionLink = $ts("<li>").display($ts("<a>", { href: "#" }).display(name));
        let ionXic = ion.Select(function (a) {
            let data = $from(a.chromatogram);

            return {
                rt: data.Select(i => i.Time).ToArray(),
                intensity: data.Select(i => i.Intensity).ToArray(),
                adducts: a.source
            };
        }).ToArray();

        ions_list.appendElement(ionLink);
        ionLink.onclick = function () {
            $ts("#ionname").display(name);
            show_tic(ionXic, "overlaps");
        }
    }
</script>

</html>